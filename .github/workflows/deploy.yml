name: Deploy internship_app + Trigger DevOps Agent on Failure

on:
  workflow_dispatch:
    inputs:
      simulate_bad_db_pass:
        description: "Set true to break DB_PASS and simulate incident"
        required: true
        default: "true"
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH (POC-safe)
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.EC2_SSH_KEY }}" | sed 's/\r$//' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat >> ~/.ssh/config <<'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

      - name: Deploy to EC2 (rsync code, exclude config.php)
        run: |
          rsync -az --delete --exclude 'config.php' \
            -e "ssh -i ~/.ssh/id_rsa" \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/internship_app/

      - name: Render config.php locally + upload to EC2
        env:
          SIMULATE: ${{ github.event.inputs.simulate_bad_db_pass || 'false' }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS_GOOD: ${{ secrets.DB_PASS_GOOD }}
          DB_PASS_BAD: ${{ secrets.DB_PASS_BAD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          set -euo pipefail

          if [ "$SIMULATE" = "true" ]; then
            EFFECTIVE_PASS="$DB_PASS_BAD"
          else
            EFFECTIVE_PASS="$DB_PASS_GOOD"
          fi

          cat > /tmp/config.php <<EOF
          <?php
          \$db_host = "${DB_HOST}";
          \$db_user = "${DB_USER}";
          \$db_pass = "${EFFECTIVE_PASS}";
          \$db_name = "${DB_NAME}";
          
          if (!defined("INSTALLING")) {
            \$conn = new mysqli(\$db_host, \$db_user, \$db_pass, \$db_name);
            if (\$conn->connect_error) {
              http_response_code(500);
              die("DB Connection Failed: " . \$conn->connect_error);
            }
          }
          ?>
          EOF

          scp -i ~/.ssh/id_rsa /tmp/config.php \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/config.php

          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo bash -lc '
            mkdir -p /var/www/html/internship_app
            rsync -a --delete /tmp/internship_app/ /var/www/html/internship_app/

            mv /tmp/config.php /var/www/html/internship_app/config.php
            chown -R apache:apache /var/www/html/internship_app || true
            chmod -R 755 /var/www/html/internship_app || true

            php -l /var/www/html/internship_app/config.php

            systemctl restart httpd || systemctl restart apache2
          '"

      # IMPORTANT: do NOT fail here. Capture HTTP code so later steps can run.
      - name: Smoke test (health) - capture status
        id: smoke
        run: |
          set +e
          url="http://${{ secrets.EC2_HOST }}/internship_app/health.php"
          echo "Hitting: $url"
          code=$(curl -s -o /tmp/health_body.txt -w "%{http_code}" "$url")
          echo "HTTP_CODE=$code"
          cat /tmp/health_body.txt || true
          echo "http_code=$code" >> $GITHUB_OUTPUT
          exit 0

      - name: Collect EC2 diagnostics (only if smoke failed)
        if: ${{ steps.smoke.outputs.http_code != '200' }}
        run: |
          # Always create the file even if SSH fails, so artifact upload has something
          {
            echo "=== github run url ==="
            echo "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
            echo "=== smoke http code ==="
            echo "${{ steps.smoke.outputs.http_code }}"
            echo "=== time (UTC) ==="
            date -u
            echo
            echo "=== EC2 diagnostics ==="
            ssh -i ~/.ssh/id_rsa \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo bash -lc '
                echo \"=== curl localhost health ===\"
                curl -i http://localhost/internship_app/health.php || true

                echo \"=== config.php head ===\"
                sed -n \"1,60p\" /var/www/html/internship_app/config.php || true

                echo \"=== php modules (mysqli/pdo_mysql) ===\"
                php -m | egrep -i \"mysqli|pdo_mysql\" || true

                echo \"=== apache error log tail ===\"
                tail -n 120 /var/log/httpd/error_log 2>/dev/null || true
                tail -n 120 /var/log/apache2/error.log 2>/dev/null || true

                echo \"=== php errors tail ===\"
                tail -n 120 /var/log/php_errors.log 2>/dev/null || true
              '"
          } | tee /tmp/ec2_diagnostics.txt

      - name: Upload diagnostics artifact (only if smoke failed)
        if: ${{ steps.smoke.outputs.http_code != '200' }}
        uses: actions/upload-artifact@v4
        with:
          name: ec2-diagnostics
          path: /tmp/ec2_diagnostics.txt

      - name: Fail job if smoke failed (after evidence collected)
        if: ${{ steps.smoke.outputs.http_code != '200' }}
        run: |
          echo "Smoke test failed with HTTP ${{ steps.smoke.outputs.http_code }}"
          exit 1

  trigger_devops_agent:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: ${{ failure() }}

    steps:
      - name: Download diagnostics artifact (if present)
        uses: actions/download-artifact@v4
        with:
          name: ec2-diagnostics
          path: /tmp/ec2-diagnostics

      - name: Trigger AWS DevOps Agent via webhook
        env:
          WEBHOOK_URL: ${{ secrets.DEVOPS_AGENT_WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.DEVOPS_AGENT_WEBHOOK_SECRET }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          TARGET_RESOURCE_TYPE: ec2
          TARGET_RESOURCE_ID: ${{ secrets.TARGET_RESOURCE_ID }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -euo pipefail

          TS="$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
          INCIDENT_ID="github-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          # Artifact typically downloads into /tmp/ec2-diagnostics/ec2_diagnostics.txt
          DIAG_FILE="$(find /tmp/ec2-diagnostics -type f -name 'ec2_diagnostics.txt' 2>/dev/null | head -n 1 || true)"

          if [ -n "${DIAG_FILE}" ] && [ -f "${DIAG_FILE}" ]; then
            DIAG="$(sed 's/"/\\"/g' "${DIAG_FILE}" | tail -n 2000 | tr '\n' '\\n')"
          else
            DIAG="(no diagnostics file found under /tmp)"
          fi

          if [ -z "${TARGET_RESOURCE_ID}" ]; then
            echo "ERROR: TARGET_RESOURCE_ID is empty. Set GitHub secret EC2_INSTANCE_ID."
            exit 2
          fi

          set -euo pipefail
          
          TS="$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
          INCIDENT_ID="github-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          
          # Build PAYLOAD first (must be set before SIG)
          PAYLOAD="$(cat <<EOF
          {
            "eventType": "incident",
            "incidentId": "${INCIDENT_ID}",
            "action": "created",
            "priority": "HIGH",
            "title": "POC: internship_app deploy/smoke failed (GitHub Actions)",
            "description": "Repo=${GITHUB_REPOSITORY} Run=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} SHA=${GITHUB_SHA} Ref=${GITHUB_REF_NAME}",
            "service": "internship_app",
            "timestamp": "${TS}",
            "data": {
              "metadata": {
                "accountId": "${AWS_ACCOUNT_ID}",
                "region": "${AWS_REGION}",
                "resourceType": "${TARGET_RESOURCE_TYPE}",
                "resourceId": "${TARGET_RESOURCE_ID}",
                "endpoint": "http://${EC2_HOST}/internship_app/health.php",
                "repo": "${GITHUB_REPOSITORY}",
                "ref": "${GITHUB_REF_NAME}",
                "sha": "${GITHUB_SHA}",
                "run_id": "${GITHUB_RUN_ID}"
              },
              "evidence": {
                "ec2Diagnostics": "${DIAG:-"(no diag)"}"
              }
            }
          }
          EOF
          )"
          
          # IMPORTANT: compute SIG after PAYLOAD exists
          SIG="$(printf "%s:%s" "$TS" "$PAYLOAD" \
            | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" -binary \
            | openssl base64 -A)"
          
          echo "Posting to webhook..."
          curl -sS -i -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "x-amzn-event-timestamp: ${TS}" \
            -H "x-amzn-event-signature: ${SIG}" \
            -d "$PAYLOAD"
